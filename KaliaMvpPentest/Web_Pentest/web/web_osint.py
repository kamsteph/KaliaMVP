# web_osint.py
import requests
import socket
import dns.resolver
import shodan
from urllib.parse import urlparse
import os
import logging

from dotenv import load_dotenv

from back_end.utils.colored_logger import get_logger

# Configure logger for this module
logger = get_logger(__name__,component="OSINT",region="WEB")
logger.setLevel(logging.DEBUG)

load_dotenv()
SHODAN_API_KEY = os.getenv("SHODAN_API_KEY","dIhYRp1lzsuNFcskwa8tQwIWZ0mRDf8b")  # Make sure this is set

def dns_lookup(domain):
    results = {}
    try:
        logger.debug("Performing DNS lookup for domain: %s", domain)
        results['A'] = [r.address for r in dns.resolver.resolve(domain, 'A')]
        results['MX'] = [str(r.exchange) for r in dns.resolver.resolve(domain, 'MX')]
        results['NS'] = [str(r.target) for r in dns.resolver.resolve(domain, 'NS')]
        logger.info("DNS lookup successful for domain=%s", domain)
    except Exception as e:
        logger.error("DNS lookup failed for %s: %s", domain, e)
        results['error'] = str(e)
    return results

def shodan_lookup(ip):
    results = {}
    if not SHODAN_API_KEY:
        logger.warning("SHODAN_API_KEY not set - skipping Shodan lookup")
        return {"error": "SHODAN_API_KEY not set"}
    try:
        logger.debug("Performing Shodan lookup for IP: %s", ip)
        api = shodan.Shodan(SHODAN_API_KEY)
        host = api.host(ip)
        results = {
            "ip": host["ip_str"],
            "org": host.get("org", "n/a"),
            "os": host.get("os", "n/a"),
            "ports": host.get("ports", []),
            "vulns": host.get("vulns", []),
        }
        logger.info("Shodan lookup successful for IP=%s", ip)
    except Exception as e:
        logger.error("Shodan lookup failed for IP=%s: %s", ip, e)
        results["error"] = str(e)
    return results

# --- MAIN TARGET OSINT ---
def gather_main_osint_info(url):
    logger.info("[OSINT] Gathering headers/DNS/Shodan for: %s", url)
    try:
        headers = requests.get(url, timeout=5).headers
        logger.debug("Fetched HTTP headers for %s", url)
    except Exception as e:
        logger.error("Failed to fetch headers for %s: %s", url, e)
        headers = {}

    # DNS lookup
    parsed_url = urlparse(url)
    domain = parsed_url.netloc
    dns_info = dns_lookup(domain)

    # Resolve IP from domain
    try:
        ip = socket.gethostbyname(domain)
        logger.debug("Resolved domain %s to IP %s", domain, ip)
    except Exception as e:
        logger.error("Failed to resolve domain %s to IP: %s", domain, e)
        ip = None

    # Shodan lookup
    shodan_info = shodan_lookup(ip) if ip else {"error": "IP resolution failed"}

    return {
        "headers": dict(headers),
        "dns": dns_info,
        "shodan": shodan_info,
        "ip": ip
    }

# --- SOCIAL MEDIA OSINT ---
def gather_social_osint_info(social_urls):
    results = []
    for url in social_urls:
        logger.info("[SOCIAL-OSINT] Checking: %s", url)
        try:
            response = requests.get(url, timeout=5)
            logger.debug("Social URL %s responded with status %s", url, response.status_code)
            results.append((url, response.status_code))
        except Exception as e:
            logger.warning("Social URL %s unreachable: %s", url, e)
            results.append((url, 'unreachable'))
    return results
