import asyncio
import websockets
import json
from back_end.event_bus import EventBus


class WebSocketBridge:
    """
    Bridges internal EventBus messages to external WebSocket clients.
    """

    def __init__(self, event_bus: EventBus):
        self.event_bus = event_bus
        self.clients = set()
        self.server = None  # will hold the running WebSocket server

        # Subscribe to events from the EventBus
        event_bus.subscribe("scan_progress", self.forward_event)
        event_bus.subscribe("scan_complete", self.forward_event)

    async def forward_event(self, payload):
        """
        Forwards an event from the EventBus to all connected WebSocket clients.
        """
        message = json.dumps({
            "event": payload.get("event", "unknown"),
            "payload": payload
        })
        # Send to all connected clients
        await asyncio.gather(*[client.send(message) for client in self.clients], return_exceptions=True)

    async def handler(self, websocket, path):
        """
        Handles a new WebSocket client connection.
        """
        self.clients.add(websocket)
        try:
            # The async for loop will receive messages, even if you don't expect them.
            # It's a standard pattern to keep the connection open.
            async for _ in websocket:
                pass
        finally:
            self.clients.remove(websocket)

    async def start(self, host="192.168.106.154", port=9000):
        """
        Starts the WebSocket server and keeps a reference so we can stop it later.
        """
        self.server = await websockets.serve(self.handler, host, port)
        print(f"[WebSocketBridge] Listening on ws://{host}:{port}")

    async def stop(self):
        """
        Stops the WebSocket server gracefully.
        """
        if self.server:
            self.server.close()
            await self.server.wait_closed()
            print("[WebSocketBridge] Server stopped")

    def _on_connect(self, websocket):
        """Track new client connection."""
        self.clients.add(websocket)

    def _on_disconnect(self, websocket):
        """Remove disconnected client."""
        self.clients.discard(websocket)